{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

# Ensure native build toolchain needed by node-gyp (npm install of native deps).
if ! command -v pacman >/dev/null 2>&1; then
  exit 0
fi

missing=()
command -v make >/dev/null 2>&1 || missing+=(make)
command -v gcc >/dev/null 2>&1 || missing+=(gcc)

if [ ${#missing[@]} -eq 0 ]; then
  exit 0
fi

if [ "$(id -u)" -eq 0 ]; then
  pacman -S --needed --noconfirm "${missing[@]}"
  exit 0
fi

if command -v sudo >/dev/null 2>&1; then
  if [ -t 0 ]; then
    sudo pacman -S --needed --noconfirm "${missing[@]}"
    exit 0
  fi

  if sudo -n true >/dev/null 2>&1; then
    sudo -n pacman -S --needed --noconfirm "${missing[@]}"
    exit 0
  fi
fi

echo "warning: missing build tools: ${missing[*]}" >&2
echo "run once manually: sudo pacman -S --needed ${missing[*]}" >&2
{{- end }}
