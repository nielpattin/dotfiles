{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

if ! command -v fish >/dev/null 2>&1; then
  echo "warning: fish not found; skipping VS Code terminal profile setup." >&2
  exit 0
fi

FISH_BIN="$(command -v fish)"
PY_BIN=""
for c in python3 python; do
  if command -v "$c" >/dev/null 2>&1; then
    PY_BIN="$(command -v "$c")"
    break
  fi
done

for SETTINGS in \
  "$HOME/.vscode-server/data/Machine/settings.json" \
  "$HOME/.vscode-server-insiders/data/Machine/settings.json"; do
  mkdir -p "$(dirname "$SETTINGS")"

  if [ -n "$PY_BIN" ]; then
    "$PY_BIN" - <<'PY' "$SETTINGS" "$FISH_BIN"
import json
from pathlib import Path
import sys

settings_path = Path(sys.argv[1])
fish_bin = sys.argv[2]

data = {}
if settings_path.exists():
    try:
        raw = settings_path.read_text(encoding="utf-8").strip()
        data = json.loads(raw) if raw else {}
    except Exception:
        data = {}

if not isinstance(data, dict):
    data = {}

profiles = data.get("terminal.integrated.profiles.linux")
if not isinstance(profiles, dict):
    profiles = {}

profiles["fish"] = {"path": fish_bin}
data["terminal.integrated.profiles.linux"] = profiles
data["terminal.integrated.defaultProfile.linux"] = "fish"

settings_path.write_text(json.dumps(data, indent=2) + "\n", encoding="utf-8")
PY
  else
    # Fallback when Python is unavailable: only create file if absent.
    if [ ! -f "$SETTINGS" ]; then
      cat >"$SETTINGS" <<EOF
{
  "terminal.integrated.profiles.linux": {
    "fish": {
      "path": "$FISH_BIN"
    }
  },
  "terminal.integrated.defaultProfile.linux": "fish"
}
EOF
    else
      echo "warning: Python unavailable; could not safely merge into $SETTINGS" >&2
    fi
  fi
done
{{- end }}
