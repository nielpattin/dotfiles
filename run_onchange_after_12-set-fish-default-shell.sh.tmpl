{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

TARGET_USER="${SUDO_USER:-$USER}"

if ! command -v fish >/dev/null 2>&1; then
  echo "warning: fish is not installed; skipping default shell setup." >&2
  exit 0
fi

FISH_BIN="$(command -v fish)"

# Ensure fish is a valid login shell.
if [ -f /etc/shells ] && ! grep -Fxq "$FISH_BIN" /etc/shells; then
  if [ "$(id -u)" -eq 0 ]; then
    printf '%s\n' "$FISH_BIN" >> /etc/shells
  elif command -v sudo >/dev/null 2>&1; then
    if [ -t 0 ]; then
      printf '%s\n' "$FISH_BIN" | sudo tee -a /etc/shells >/dev/null
    elif sudo -n true >/dev/null 2>&1; then
      printf '%s\n' "$FISH_BIN" | sudo -n tee -a /etc/shells >/dev/null
    else
      echo "warning: could not add $FISH_BIN to /etc/shells (sudo prompt unavailable)." >&2
    fi
  fi
fi

LOGIN_SHELL="$(getent passwd "$TARGET_USER" | awk -F: '{print $7}')"
if [ "$LOGIN_SHELL" = "$FISH_BIN" ]; then
  exit 0
fi

if [ "$(id -u)" -eq 0 ]; then
  if command -v chsh >/dev/null 2>&1; then
    chsh -s "$FISH_BIN" "$TARGET_USER" || true
  elif command -v usermod >/dev/null 2>&1; then
    usermod -s "$FISH_BIN" "$TARGET_USER" || true
  fi
  exit 0
fi

# Prefer interactive chsh when a TTY is available.
if command -v chsh >/dev/null 2>&1 && [ -t 0 ]; then
  chsh -s "$FISH_BIN" "$TARGET_USER" || true
  exit 0
fi

# Non-interactive fallback via passwordless sudo.
if command -v sudo >/dev/null 2>&1 && sudo -n true >/dev/null 2>&1 && command -v usermod >/dev/null 2>&1; then
  sudo -n usermod -s "$FISH_BIN" "$TARGET_USER" || true
  exit 0
fi

echo "warning: could not set fish as default shell automatically." >&2
echo "run once manually: chsh -s $FISH_BIN" >&2
{{- end }}
